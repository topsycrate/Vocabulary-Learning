<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-M" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vocabulary Mini</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#e8ecf1; --muted:#9fb0c6; --accent:#5cc8ff; --good:#33d17a; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, Segoe UI, Roboto, Helvetica, Arial, 'Noto Sans', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:6px 0 14px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#5cc8ff,#8b5cff);display:grid;place-items:center;font-weight:800;color:white}
    .title{font-weight:700;font-size:18px}
    .panel{background:var(--card);border:1px solid #1a253b;border-radius:14px;padding:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){ .grid{grid-template-columns:1.1fr 1fr} }
    select,button,input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #263149;background:#0e1626;color:var(--text);font-size:15px}
    button.primary{background:linear-gradient(135deg,#2970ff,#5cc8ff);border:none;color:#fff;font-weight:700}
    button.ghost{background:#0e1626}
    button:disabled{opacity:.6}
    .muted{color:var(--muted);font-size:13px}
    .card{border:1px solid #20314f;background:#0f1829;border-radius:12px;padding:12px}
    .term{font-size:22px;font-weight:900;margin:2px 0 6px;display:flex;align-items:center;gap:8px}
    .ipa{font-size:16px;color:#bcd0ea}
    .stars{font-size:16px; color: #ffc700;}
    .defs{color:#d6e2f5;font-size:15px;line-height:1.6}
    .ch-part { color: #a9b8ce; font-size: 14px; margin-left: 8px; display: none; }
    .quiz{margin-top:10px}
    .q-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0e1626;border:1px solid #20314f;color:#bcd0ea}
    .question{border:1px solid #20314f;background:#0f1829;border-radius:12px;padding:14px}
    .q-term{font-size:20px;font-weight:900;margin:0 0 10px}
    .options{display:grid;gap:8px}
    .opt{border:1px solid #20314f;background:#0e1626;color:#e8f0ff;border-radius:10px;padding:12px;text-align:left}
    .opt.correct{border-color:#1eb980;background:#0e2320}
    .opt.wrong{border-color:#ff6b6b;background:#261417}
    .status{margin-top:10px;font-size:14px}
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .bar{height:8px;background:#0e1626;border:1px solid #20314f;border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#2970ff,#5cc8ff)}
    footer{margin:18px 0 10px;color:#92a7c7;font-size:12px}
    .row{display:flex;gap:10px}
    .note{font-size:12px;color:#9fb0c6;margin-top:6px}
    .counts{display:flex; gap:10px; align-items:center; justify-content:center}
    .good{color: var(--good); font-weight:700}
    .bad{color: var(--bad); font-weight:700}
    .speak{border:1px solid #20314f;background:#0e1626;color:#e8f0ff;border-radius:8px;padding:6px 10px;font-size:13px}
    .def-reveal{margin-top:10px;border-top:1px dashed #20314f;padding-top:10px;cursor:pointer}
    .hint{font-size:12px;color:#9fb0c6;margin-top:6px}
    .checkbox-wrapper{display:flex;align-items:center;gap:8px;margin-top:10px;}
    .checkbox-wrapper label{font-size:14px;color:var(--muted);cursor:pointer;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">V</div>
        <div>
          <div class="title">Vocabulary Mini</div>
          <div class="muted">Eurasia International School</div>
        </div>
      </div>
    </header>
    <div class="grid">
      <section class="panel">
        <div style="display:grid;gap:10px">
          <label>
            <div class="muted">选择单词表 (CSV)</div>
            <select id="csvSelect"></select>
          </label>
          <label>
            <div class="muted">选择单元</div>
            <select id="unitSelect" disabled></select>
          </label>
          <div class="row">
            <button class="primary" id="btnStudy" disabled>开始学习</button>
            <button class="ghost" id="btnQuiz" disabled>开始测验</button>
          </div>
          <div class="note">学习：逐个单词 + IPA + 发音；不认识会重复。测验：选择正确释义。</div>
        </div>
      </section>
      <section class="panel" id="content">
        <div class="muted">请先选择一个单词表加载...</div>
      </section>
    </div>
    <footer>Build time: 2025-10-13 Copyright。</footer>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
// --- 全局变量 ---
let ALL_WORDS = []; // 存储从CSV加载的所有单词

// --- DOM 引用 ---
const csvSelect = document.getElementById('csvSelect');
const unitSelect = document.getElementById('unitSelect');
const btnStudy = document.getElementById('btnStudy');
const btnQuiz = document.getElementById('btnQuiz');
const content = document.getElementById('content');

// --- CSV 文件列表 ---
const CSV_FILES = [
    "word_definitions.csv",
];

// --- 核心功能 ---

function loadCSV(filename) {
    content.innerHTML = `<div class="muted">正在加载 ${filename}...</div>`;
    Papa.parse(`/vocabulary/${filename}`, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            ALL_WORDS = results.data.map(row => ({
                unit: row.Unit || 'Default',
                term: row.Word,
                ipa: row.Phonetic,
                def: row.Definition,
                masked: row['Cloze Test'],
                frequency: row.Frequency,
                chinese_def: row['Chinese Definition']
            }));
            populateUnitSelector();
            content.innerHTML = `<div class="muted">加载成功！请选择一个单元开始学习或测验。</div>`;
            unitSelect.disabled = false;
            btnStudy.disabled = false;
            btnQuiz.disabled = false;
        },
        error: function(err) {
            content.innerHTML = `<div class="muted" style="color:var(--bad)">加载文件失败: ${filename}。请确保文件存在于 /vocabulary/ 目录下。</div>`;
            console.error("CSV Loading Error:", err);
        }
    });
}

function populateUnitSelector() {
    const uniqueUnits = [...new Set(ALL_WORDS.map(w => w.unit))].sort();
    unitSelect.innerHTML = uniqueUnits.map(u => `<option value="${u}">${u}</option>`).join('');
}


// --- 辅助函数 ---
const byUnit = (u) => ALL_WORDS.filter(w => w.unit === u);
const shuffle = (arr) => arr.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(p => p[1]);

function speak(text) {
    try {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
    } catch (e) {}
}

function renderStars(frequency) {
    if (!frequency || frequency === 'N/A') return '';
    const match = frequency.match(/(\d+)\s*\/\s*5/);
    if (!match) return '';
    const count = parseInt(match[1], 10);
    return '★'.repeat(count) + '☆'.repeat(5 - count);
}


// --- 学习模式 ---
function renderStudy(unit) {
    let pool = shuffle(byUnit(unit));
    let current = null;
    let seen = 0, known = 0, unknown = 0;

    function draw() {
        if (pool.length === 0) {
            content.innerHTML = `<div class="q-head"><div class="pill">学习模式 · ${unit}</div><div class="muted">完成！已掌握：${known}，待复习：${unknown}</div></div>`;
            return;
        }
        current = pool.shift();
        seen++;
        const ipa = current.ipa && current.ipa.trim() ? current.ipa : '—';
        const starsHTML = `<span class="stars">${renderStars(current.frequency)}</span>`;
        
        // **核心修改 1**: 如果没有英文释义，则用中文释义代替
        const hasEnDef = current.def && !current.def.includes('No Collins');
        let enDefs = [];
        let chDefs = [];
        let combinedDef = '';
        const hasChineseDef = current.chinese_def && current.chinese_def !== 'N/A';
        
        if (hasEnDef) {
            enDefs = current.def.split(' | ');
            if (hasChineseDef) {
                chDefs = current.chinese_def.split(' | ');
            }
            combinedDef = enDefs.map((en, index) => {
                const ch = chDefs[index] || '';
                return `${en}<span class="ch-part">${ch}</span>`;
            }).join('<br>');
        } else if (hasChineseDef) {
            // 没有英文释义，直接使用中文释义
            combinedDef = current.chinese_def.replace(/ \| /g, '<br>');
        } else {
            combinedDef = '暂无释义';
        }

        const chineseToggleHTML = (hasEnDef && hasChineseDef) ? `
            <div class="checkbox-wrapper">
                <input type="checkbox" id="toggleChinese">
                <label for="toggleChinese">显示中文释义</label>
            </div>` : '';


        content.innerHTML = `
            <div class="q-head" style="justify-content:space-between;">
                <div class="pill">学习模式 · ${unit}</div>
                <div class="pill">${seen}</div>
            </div>
            <div class="card">
                <div class="term">
                    <span>${current.term}</span>
                    <button class="speak" id="speakBtn">🔊 发音</button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="ipa">${ipa}</div>
                    ${starsHTML}
                </div>
                ${chineseToggleHTML}
                <div class="hint">点“认识/不认识”都会显示释义；再点释义进入下一词。</div>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button class="primary" id="btnKnow">认识</button>
                    <button class="ghost" id="btnDont">不认识</button>
                </div>
                <div id="revealBox"></div>
            </div>`;

        document.getElementById('speakBtn').onclick = () => speak(current.term);
        
        if (hasEnDef && hasChineseDef) {
            document.getElementById('toggleChinese').addEventListener('change', (e) => {
                const chParts = document.querySelectorAll('.ch-part');
                chParts.forEach(part => {
                    part.style.display = e.target.checked ? 'inline' : 'none';
                });
            });
        }

        const revealBox = document.getElementById('revealBox');
        function reveal(mark) {
            if (mark === 'known') known++; else unknown++;
            revealBox.innerHTML = `
                <div class="def-reveal" id="defReveal">
                    <div class="defs">${combinedDef}</div>
                    <div class="hint">（再点一下释义，进入下一词）</div>
                </div>`;
            document.getElementById('defReveal').onclick = () => {
                if (mark === 'unknown') {
                    const delay = Math.floor(Math.random() * 3) + 3;
                    pool.splice(Math.min(delay, pool.length), 0, current);
                }
                draw();
            };
        }
        document.getElementById('btnKnow').onclick = () => reveal('known');
        document.getElementById('btnDont').onclick = () => reveal('unknown');
    }
    draw();
}

// --- 测验模式 ---
function buildOptions(allInUnit, correct) {
    const wrongPool = allInUnit.filter(w => w.term !== correct.term);
    const picks = shuffle(wrongPool).slice(0, 3).map(w => w.masked);
    const opts = shuffle([correct.masked, ...picks]);
    return opts;
}

function renderQuiz(unit) {
    // **核心修改 2**: 过滤掉不符合测验条件的单词
    const allWordsInUnit = byUnit(unit);
    const quizableWords = allWordsInUnit.filter(w => {
        const hasEnDef = w.def && !w.def.includes('No Collins');
        const hasMasked = w.masked && w.masked !== 'N/A';
        return hasEnDef && hasMasked;
    });

    if (quizableWords.length < 4) {
        content.innerHTML = `<div class="muted">本单元可供测验的单词不足4个，无法开始测验。</div>`;
        return;
    }

    const list = shuffle(quizableWords);
    let idx = 0, correct = 0, wrong = 0;

    function headerHTML() {
        return `
            <div class="q-head">
                <div class="pill">测验模式 · ${unit}</div>
                <div class="counts"><span class="good">正确：${correct}个</span><span class="bad">错误：${wrong}个</span></div>
                <div class="pill" id="pillProg">${idx}/${list.length}</div>
            </div>`;
    }

    content.innerHTML = headerHTML() + `
        <div class="bar"><i id="barFill"></i></div>
        <div class="quiz">
            <div class="question" id="qbox"></div>
            <div class="status" id="qStatus"></div>
            <div style="margin-top:10px;display:flex;gap:8px">
                <button class="ghost" id="btnPrev" disabled>上一题</button>
                <button class="ghost" id="btnNext" disabled>下一题</button>
                <button class="primary" id="btnRestart" style="margin-left:auto">重新开始</button>
            </div>
        </div>`;

    const qStatus = () => document.getElementById('qStatus');
    const pillProg = () => document.getElementById('pillProg');
    const barFill = () => document.getElementById('barFill');
    const btnPrev = () => document.getElementById('btnPrev');
    const btnNext = () => document.getElementById('btnNext');
    const btnRestart = () => document.getElementById('btnRestart');

    function updateBar() {
        pillProg().textContent = `${idx}/${list.length}`;
        barFill().style.width = `${(idx / list.length) * 100}%`;
        content.querySelector('.q-head').outerHTML = headerHTML();
    }

    function showQuestion() {
        const qbox = document.getElementById('qbox');
        const w = list[idx];
        const options = buildOptions(list, w); // 使用过滤后的列表来构建选项
        qbox.innerHTML = `
            <div class="q-term">${w.term}</div>
            <div class="muted" style="margin:-4px 0 10px">选择正确的英文释义（已屏蔽）</div>
            <div class="options">
                ${options.map((o, i) => `<button class="opt" data-i="${i}">${o}</button>`).join('')}
            </div>`;
        qStatus().textContent = '';
        btnNext().disabled = true;
        btnPrev().disabled = idx === 0;

        qbox.querySelectorAll('.opt').forEach(btn => {
            btn.addEventListener('click', () => {
                const chosen = btn.textContent;
                const correctMasked = w.masked;
                const nodes = qbox.querySelectorAll('.opt');
                nodes.forEach(n => { if (n.textContent === correctMasked) n.classList.add('correct'); });
                if (chosen === correctMasked) {
                    btn.classList.add('correct'); qStatus().textContent = '✔ 正确！'; qStatus().className = 'status good'; correct++;
                } else {
                    btn.classList.add('wrong'); qStatus().textContent = `✖ 错误。正确答案：${w.def.replace(/ \| /g, '<br>')}`; qStatus().className = 'status bad'; wrong++;
                }
                nodes.forEach(n => n.disabled = true);
                btnNext().disabled = false;
                setTimeout(() => { if (!btnNext().disabled) next(); }, 1200);
                updateBar();
            }, { once: true });
        });
        updateBar();
    }

    function next() {
        idx++;
        if (idx >= list.length) {
            const qbox = document.getElementById('qbox');
            qbox.innerHTML = `<div class="q-term">完成！</div><div class="muted">得分：${correct} / ${list.length} · 错误：${wrong}</div>`;
            qStatus().textContent = '';
            pillProg().textContent = `${list.length}/${list.length}`;
            barFill().style.width = '100%';
            btnNext().disabled = true;
            btnPrev().disabled = list.length === 0;
            updateBar();
            return;
        }
        showQuestion();
    }

    btnPrev().addEventListener('click', () => { if (idx > 0) { idx--; showQuestion(); } });
    btnNext().addEventListener('click', () => { next(); });
    btnRestart().addEventListener('click', () => { renderQuiz(unit); });

    showQuestion();
}

// --- 事件监听与初始化 ---
csvSelect.innerHTML = CSV_FILES.map(f => `<option value="${f}">${f}</option>`).join('');
csvSelect.addEventListener('change', (e) => { loadCSV(e.target.value); });
btnStudy.addEventListener('click', () => { const unit = unitSelect.value; renderStudy(unit); });
btnQuiz.addEventListener('click', () => { const unit = unitSelect.value; renderQuiz(unit); });

if (CSV_FILES.length > 0) {
    loadCSV(CSV_FILES[0]);
}

</script>
</body>
</html>
